
app.use(cors());
app.use(express.json());

const server = http.createServer(app);
const io = new Server(server,{cors:{origin:"*"}});

const db = new sqlite3.Database('./aiRadar.db',(err)=>{if(err) console.error(err.message); else console.log('Connected to DB.');});

db.run(`CREATE TABLE IF NOT EXISTS tasks (id INTEGER PRIMARY KEY AUTOINCREMENT,name TEXT,status TEXT,accuracy REAL)`);

app.get('/tasks',(req,res)=>{ db.all('SELECT * FROM tasks',[],(err,rows)=>err?res.status(500).send(err.message):res.json(rows));});
app.post('/tasks',(req,res)=>{ const {name,status,accuracy}=req.body; db.run(`INSERT INTO tasks (name,status,accuracy) VALUES (?,?,?)`,[name,status,accuracy],function(err){if(err)return res.status(500).send(err.message); io.emit("updateTasks"); res.json({id:this.lastID});});});
app.put('/tasks/:id',(req,res)=>{ const {id}=req.params; const {name,status,accuracy}=req.body; db.run(`UPDATE tasks SET name=?, status=?, accuracy=? WHERE id=?`,[name,status,accuracy,id],function(err){if(err)return res.status(500).send(err.message); io.emit("updateTasks"); res.json({updated:this.changes});});});
app.delete('/tasks/:id',(req,res)=>{ const {id}=req.params; db.run(`DELETE FROM tasks WHERE id=?`,[id],function(err){if(err)return res.status(500).send(err.message); io.emit("updateTasks"); res.json({deleted:this.changes});});});

app.use(express.static(path.join(__dirname,'../frontend/build')));
app.get('*',(req,res)=>{res.sendFile(path.join(__dirname,'../frontend/build','index.html'));});

server.listen(PORT,()=>console.log(`Server running on port ${PORT}`));
// --- AUTO-ADDED SCANNER LOOP ---

async function scanForWork() {
    console.log("ðŸ‘€ Scanning for new tasks...");
    const randomChance = Math.random();
    
    if (randomChance > 0.7) { 
        const newTask = { name: "Training AI Model - Python", status: "New", accuracy: 0.0 };
        db.run(`INSERT INTO tasks (name, status, accuracy) VALUES (?,?,?)`, 
            [newTask.name, newTask.status, newTask.accuracy], 
            function(err) {
                if (err) return console.error(err.message);
                console.log(`ðŸš¨ ALERT: New Task Found! ID: ${this.lastID}`);
                io.emit("updateTasks"); 
            }
        );
    } else {
        console.log("...No new tasks found.");
    }
}

setInterval(scanForWork, 10000);
// --- NEW: Allow External Bot to Add Tasks ---
app.post('/api/add-task', (req, res) => {
    const { name, status, accuracy } = req.body;
    console.log(`ðŸ¤– Bot is adding a task: ${name}`);
    
    // Insert into Database
    const sql = `INSERT INTO tasks (name, status, accuracy) VALUES (?,?,?)`;
    db.run(sql, [name, status, accuracy], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        
        // Update the live dashboard immediately
        io.emit("updateTasks"); 
        res.json({ message: "Task added successfully!", id: this.lastID });
    });
});
